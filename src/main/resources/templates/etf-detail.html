<!DOCTYPE html>
<html lang="ko">
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§„ê²©ì˜ ETF</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/load-components.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- Header -->
<!--
<header class="bg-white shadow-md p-4">
    <h1 class="text-2xl font-bold text-blue-600">ETF ì¢…ëª© ìƒì„¸</h1>
</header>
-->

<div id="header-placeholder"></div>

<!-- Main -->
<main class="max-w-7xl mx-auto p-6 grid grid-cols-12 gap-6">

    <!-- Left : ì¢…ëª© ê¸°ë³¸ ì •ë³´ -->
    <aside class="col-span-3 bg-white rounded-2xl shadow p-4">
        <h2 class="text-xl font-semibold mb-3">ğŸ“Š ì¢…ëª© ê¸°ë³¸ ì •ë³´</h2>
        <ul class="space-y-2 text-sm">
            <li><span class="font-medium">ì¢…ëª©ëª…:</span> <span th:text="${etfInfo.itmsNm}"></span></li>
            <li><span class="font-medium">ISINì½”ë“œ:</span> <span th:text="${etfInfo.isinCd}"></span></li>
            <li><span class="font-medium">ê¸°ì´ˆì§€ìˆ˜ëª…:</span> <span th:text="${etfInfo.bssIdxIdxNm}"></span></li>
            <li><span class="font-medium">ê¸°ì´ˆì§€ìˆ˜ ì¢…ê°€:</span> <span th:text="${etfInfo.bssIdxClpr}"></span></li>
            <li><span class="font-medium">ì‹œê°€ì´ì•¡:</span> <span th:text="${etfInfo.mrktTotAmt}"></span></li>
            <li><span class="font-medium">ìˆœìì‚°ê°€ì¹˜:</span> <span th:text="${etfInfo.nav}"></span></li>
            <li><span class="font-medium">ìƒì¥ì¼:</span> <span th:text="${etfInfo.basDt}"></span></li>
        </ul>
    </aside>

    <!-- Center : ì°¨íŠ¸ & ì„±ê³¼ -->
    <section class="col-span-6 bg-white rounded-2xl shadow p-4">
        <h2 class="text-xl font-semibold mb-3">ğŸ“ˆ ê°€ê²© & ì„±ê³¼</h2>

        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <!-- ì°¨íŠ¸ ì»¨í…Œì´ë„ˆì— ë†’ì´ ì§€ì • -->
        <div style="width: 100%; height: 400px;">
            <canvas id="etfChart" class="h-64 w-full"></canvas>
        </div>

        <!-- ì„±ê³¼ í…Œì´ë¸” -->
        <table class="mt-4 w-full text-sm border-t">
            <thead class="bg-gray-50">
            <tr>
                <th class="p-2 text-left">êµ¬ë¶„</th>
                <th class="p-2 text-right">ì „ì²´</th>
                <!--
                <th class="p-2 text-right">1ë…„</th>
                <th class="p-2 text-right">6ê°œì›”</th>
                <th class="p-2 text-right">3ê°œì›”</th>
                <th class="p-2 text-right">1ê°œì›”</th>
                -->
            </tr>
            </thead>
            <tbody>
            <tr class="border-t">
                <td class="p-2 font-medium">ìˆ˜ìµë¥ </td>
                <td id="ret-total" class="p-2 text-right">-</td>
                <!--
                <td id="ret-1y" class="p-2 text-right">-</td>
                <td id="ret-6m" class="p-2 text-right">-</td>
                <td id="ret-3m" class="p-2 text-right">-</td>
                <td id="ret-1m" class="p-2 text-right">-</td>
                -->
            </tr>
            </tbody>
        </table>

        <h2 class="text-xl font-semibold mb-3 mt-8">ğŸ’¬ ëŒ“ê¸€</h2>
        <div id="comments-section">
            <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
            <form id="comment-form" class="space-y-4">
                <!-- ë‹‰ë„¤ì„ ì…ë ¥ í•„ë“œ -->
                <div>
                    <label for="nickname" class="block text-sm font-medium text-gray-700 sr-only">ë‹‰ë„¤ì„</label>
                    <input type="text" id="nickname" name="nickname" required
                           maxlength="20" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 20ì)"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out shadow-sm text-sm"
                           aria-label="ë‹‰ë„¤ì„ ì…ë ¥">
                </div>

                <!-- ëŒ“ê¸€ ë‚´ìš© ì…ë ¥ í•„ë“œ -->
                <div>
                    <label for="comment-content" class="block text-sm font-medium text-gray-700 sr-only">ëŒ“ê¸€ ë‚´ìš©</label>
                    <textarea id="comment-content" name="content" rows="4" required
                              placeholder="ëŒ“ê¸€ì´ë‚˜ ë¶„ì„ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out shadow-sm text-sm resize-none"
                              aria-label="ëŒ“ê¸€ ë‚´ìš© ì…ë ¥"></textarea>
                </div>

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div class="flex justify-end">
                    <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        ëŒ“ê¸€ ë“±ë¡
                    </button>
                </div>
            </form>

            <!-- ğŸ’¡ ëŒ“ê¸€ ëª©ë¡ì´ í‘œì‹œë  ì˜ì—­ -->
            <div id="comments-list" class="space-y-6 mt-6">
                <!--
                    ì—¬ê¸°ì— JavaScriptë¥¼ ì‚¬ìš©í•˜ì—¬ Firestoreì—ì„œ ê°€ì ¸ì˜¨ ê°œë³„ ëŒ“ê¸€ í•­ëª©ë“¤ì´
                    ë™ì ìœ¼ë¡œ <div class="comment-item"> í˜•íƒœë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.
                -->
                <!-- JavaScriptë¡œ ë™ì ìœ¼ë¡œ ìƒì„±ë  ê°œë³„ ëŒ“ê¸€ì˜ HTML êµ¬ì¡° ì˜ˆì‹œ -->
                <div class="comment-item p-4 bg-gray-50 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-1">
                        <!-- ë‹‰ë„¤ì„ (ì‘ì„±ì) -->
                        <span class="font-semibold text-gray-800">ì‚¬ìš©ì ë‹‰ë„¤ì„</span>
                        <!-- ì‘ì„± ì‹œê°„ -->
                        <span class="text-xs text-gray-400">2ë¶„ ì „</span>
                    </div>
                    <!-- ëŒ“ê¸€ ë‚´ìš© -->
                    <p class="text-gray-700 text-sm break-words">
                        ì´ ETFëŠ” ì¥ê¸°ì ìœ¼ë¡œ ì„±ì¥ ê°€ëŠ¥ì„±ì´ ë†’ì•„ ë³´ì…ë‹ˆë‹¤.
                    </p>
                    <!-- ì¢‹ì•„ìš”/ë°˜ì‘ ë²„íŠ¼ (ì„ íƒ ì‚¬í•­) -->
                    <div class="mt-2 text-right">
                        <button class="text-xs text-green-600 hover:text-green-800">
                            ğŸ‘ ì¢‹ì•„ìš” (0)
                        </button>
                    </div>
                </div>
                <p class="text-gray-500 text-sm text-center py-4" id="no-comments-message">
                    ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!
                </p>
            </div>
        </div>
    </section>

    <!-- Right : ë‰´ìŠ¤ & í† ë¡  -->
    <aside class="col-span-3 bg-white rounded-2xl shadow p-4">
        <h2 class="text-xl font-semibold mb-3">ğŸ“° ë‰´ìŠ¤</h2>
        <ul class="space-y-3 text-sm" id="news-list">
            <li th:each="item, stat : ${news.subList(0, T(java.lang.Math).min(10, news.size()))}">
                <a th:href="${item.link}" target="_blank" class="text-blue-600 hover:underline" th:text="${item.title}">
                </a>
                <p class="text-gray-500 text-xs" th:text="${#dates.format(item.pubDate, 'yyyy-MM-dd')}">
                </p>
            </li>

            <li th:if="${#lists.isEmpty(news)}">
                <p class="text-gray-500">ê´€ë ¨ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </li>
        </ul>

        <div class="mt-4 text-center" id="show-more-news-btn" style="display: none;">
            <button class="text-green-600 hover:text-green-800 font-medium text-sm">
                ë‰´ìŠ¤ ë”ë³´ê¸° (<span id="remaining-count"></span>ê°œ ë‚¨ìŒ)
            </button>
        </div>
    </aside>

</main>

<div id="footer-placeholder"></div>

<!-- Chart.js Script -->
<script th:inline="javascript">
    const ctx = document.getElementById('etfChart').getContext('2d');
    const etfData = /*[[${etfDetails}]]*/ []; // Thymeleafë¡œë¶€í„° ë°ì´í„° ë°›ê¸°

    const labels = etfData.map(item => item.basDt);
    const prices = etfData.map(item => item.clpr);

    // ìˆ˜ìµë¥  ê³„ì‚° í•¨ìˆ˜
    const rateOfChange = (start, end) => ((end - start) / start * 100).toFixed(2);

    // ì•ˆì „ ì¸ë±ìŠ¤ ê³„ì‚° (ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ undefined ë°©ì§€)
    const len = prices.length;
    const safeIdx = (n) => (len - n >= 0 ? len - n : 0);

    // êµ¬ê°„ë³„ ìˆ˜ìµë¥  ê³„ì‚°
    const overallChange  = rateOfChange(prices[0], prices[len - 1]);
    const oneYearChange  = rateOfChange(prices[safeIdx(252)], prices[len - 1]);
    const sixMonthChange = rateOfChange(prices[safeIdx(126)], prices[len - 1]);
    const threeMonthChange = rateOfChange(prices[safeIdx(63)], prices[len - 1]);
    const oneMonthChange = rateOfChange(prices[safeIdx(21)], prices[len - 1]);

    // í‘œì‹œìš© í¬ë§· í•¨ìˆ˜
    const formatReturn = (value) => {
      const sign = value >= 0 ? '+' : '';
      const color = value >= 0 ? 'text-red-600' : 'text-blue-600';
      return `<span class="${color}">${sign}${value}%</span>`;
    };

    // í…Œì´ë¸” ì±„ìš°ê¸°
    document.getElementById('ret-total').innerHTML = formatReturn(overallChange);
    /*
    document.getElementById('ret-1y').innerHTML    = formatReturn(oneYearChange);
    document.getElementById('ret-6m').innerHTML    = formatReturn(sixMonthChange);
    document.getElementById('ret-3m').innerHTML    = formatReturn(threeMonthChange);
    document.getElementById('ret-1m').innerHTML    = formatReturn(oneMonthChange);
    */

    const etfChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels, // ë‚ ì§œ ë°°ì—´
        datasets: [{
          label: 'ETF ê°€ê²©',
          data: prices, // ì¢…ê°€ ë°°ì—´
          borderColor: 'rgb(37, 99, 235)',
          backgroundColor: 'rgba(37, 99, 235, 0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: 'rgb(37, 99, 235)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });

    /*[# th:if="${news} and ${!#lists.isEmpty(news)}"]*/
    // ì„œë²„ì—ì„œ ë°›ì€ ì „ì²´ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ í´ë¼ì´ì–¸íŠ¸ JavaScript ë³€ìˆ˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
    const ALL_NEWS_DATA = /*[[${news}]]*/ [];
    /*[/]*/

    // í˜„ì¬ í‘œì‹œëœ ë‰´ìŠ¤ ê°œìˆ˜ë¥¼ ì¶”ì í•  ë³€ìˆ˜
    let visibleNewsCount = 10;

    document.addEventListener("DOMContentLoaded", function() {
        if (typeof ALL_NEWS_DATA !== 'undefined' && ALL_NEWS_DATA.length > 10) {
            // ì´ˆê¸° ë¡œë”© ì‹œ 10ê°œ ì´ìƒì¼ ê²½ìš°ì—ë§Œ 'ë”ë³´ê¸°' ë²„íŠ¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
            document.getElementById('show-more-news-btn').style.display = 'block';
        }

        // ì´ˆê¸° 10ê°œ í•­ëª©ë§Œ Thymeleafê°€ ë Œë”ë§í–ˆìœ¼ë¯€ë¡œ, JSëŠ” 'ë”ë³´ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        const showMoreBtn = document.getElementById('show-more-news-btn');
        if (showMoreBtn) {
            showMoreBtn.addEventListener('click', handleShowMore);

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            updateButtonText();
        }
    });

    // A. ë‰´ìŠ¤ í•­ëª©ì„ HTML ë¬¸ìì—´ë¡œ ìƒì„±í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function renderNewsItem(item) {
        // ë‚ ì§œ í¬ë§·íŒ…ì€ JSì—ì„œ ì§ì ‘ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        const formattedDate = item.pubDate ? new Date(item.pubDate).toISOString().split('T')[0] : '';

        return `
            <li>
                <a href="${item.link}" target="_blank" class="text-blue-600 hover:underline">
                    ${item.title}
                </a>
                <p class="text-gray-500 text-xs">${formattedDate}</p>
            </li>
        `;
    }

    // B. 'ë”ë³´ê¸°' ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
    function handleShowMore() {
        const container = document.getElementById('news-list');
        const newsToShow = 10; // í•œ ë²ˆì— ë³´ì—¬ì¤„ ë‰´ìŠ¤ ê°œìˆ˜

        // í˜„ì¬ í‘œì‹œí•´ì•¼ í•  ì‹œì‘ ì¸ë±ìŠ¤
        const startIndex = visibleNewsCount;
        // ìƒˆë¡œ í‘œì‹œí•  ë ì¸ë±ìŠ¤ (ì´ ê°œìˆ˜ë¥¼ ë„˜ì§€ ì•Šë„ë¡ Math.min ì‚¬ìš©)
        const endIndex = Math.min(startIndex + newsToShow, ALL_NEWS_DATA.length);

        let htmlContent = '';

        // ìƒˆë¡œ ë³´ì—¬ì¤„ ë‰´ìŠ¤ í•­ëª©ë“¤ì„ HTMLë¡œ ìƒì„±
        for (let i = startIndex; i < endIndex; i++) {
            htmlContent += renderNewsItem(ALL_NEWS_DATA[i]);
        }

        // ì»¨í…Œì´ë„ˆì— HTML ì‚½ì…
        container.insertAdjacentHTML('beforeend', htmlContent);

        // í‘œì‹œëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        visibleNewsCount = endIndex;

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° í‘œì‹œ ì—¬ë¶€ ì—…ë°ì´íŠ¸
        updateButtonText();
    }

    // C. ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° í‘œì‹œ ì—¬ë¶€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateButtonText() {
        const showMoreBtn = document.getElementById('show-more-news-btn');
        const remainingCountSpan = document.getElementById('remaining-count');

        const remainingCount = ALL_NEWS_DATA.length - visibleNewsCount;

        if (remainingCount > 0) {
            // ë‚¨ì€ í•­ëª©ì´ ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            remainingCountSpan.textContent = remainingCount;
        } else {
            // ë” ì´ìƒ ë‚¨ì€ ë‰´ìŠ¤ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            showMoreBtn.style.display = 'none';
        }
    }
</script>

</body>
</html>
