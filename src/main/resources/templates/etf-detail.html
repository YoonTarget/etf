<!DOCTYPE html>
<html lang="ko">
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진격의 ETF > 종목 상세 페이지</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/load-components.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- Header -->
<!--
<header class="bg-white shadow-md p-4">
    <h1 class="text-2xl font-bold text-blue-600">ETF 종목 상세</h1>
</header>
-->

<div id="header-placeholder"></div>

<!-- Main -->
<main class="max-w-7xl mx-auto p-6 grid grid-cols-12 gap-6">

    <!-- Left : 종목 기본 정보 -->
    <aside class="col-span-3 bg-white rounded-2xl shadow p-4">
        <h2 class="text-xl font-semibold mb-3">📊 종목 기본 정보</h2>
        <ul class="space-y-2 text-sm">
            <li><span class="font-medium">종목명:</span> <span th:text="${etfInfo.itmsNm}"></span></li>
            <li><span class="font-medium">ISIN코드:</span> <span th:text="${etfInfo.isinCd}"></span></li>
            <li><span class="font-medium">시가총액:</span> <span th:text="${etfInfo.mrktTotAmt}"></span></li>
            <li><span class="font-medium">순자산가치:</span> <span th:text="${etfInfo.nav}"></span></li>
            <li><span class="font-medium">상장일:</span> <span th:text="${etfInfo.basDt}"></span></li>
        </ul>
    </aside>

    <!-- Center : 차트 & 성과 -->
    <section class="col-span-6 bg-white rounded-2xl shadow p-4">
        <h2 class="text-xl font-semibold mb-3">📈 가격 & 성과</h2>

        <!-- 차트 영역 -->
        <!-- 차트 컨테이너에 높이 지정 -->
        <div style="width: 100%; height: 400px;">
            <canvas id="etfChart" class="h-64 w-full"></canvas>
        </div>

        <!-- 성과 테이블 -->
        <table class="mt-4 w-full text-sm border-t">
            <thead class="bg-gray-50">
            <tr>
                <th class="p-2 text-left">구분</th>
                <th class="p-2 text-right">전체</th>
                <th class="p-2 text-right">1년</th>
                <th class="p-2 text-right">6개월</th>
                <th class="p-2 text-right">3개월</th>
                <th class="p-2 text-right">1개월</th>
            </tr>
            </thead>
            <tbody>
            <tr class="border-t">
                <td class="p-2 font-medium">수익률</td>
                <td id="ret-total" class="p-2 text-right">-</td>
                <td id="ret-1y" class="p-2 text-right">-</td>
                <td id="ret-6m" class="p-2 text-right">-</td>
                <td id="ret-3m" class="p-2 text-right">-</td>
                <td id="ret-1m" class="p-2 text-right">-</td>
            </tr>
            </tbody>
        </table>
    </section>

    <!-- Right : 뉴스 & 토론 -->
    <aside class="col-span-3 bg-white rounded-2xl shadow p-4">
        <h2 class="text-xl font-semibold mb-3">📰 뉴스 & 토론</h2>
        <ul class="space-y-3 text-sm">
            <li>
                <a href="#" class="text-blue-600 hover:underline">
                    [뉴스] KODEX 200, 거래량 급증
                </a>
                <p class="text-gray-500 text-xs">2025-10-02</p>
            </li>
            <li>
                <a href="#" class="text-blue-600 hover:underline">
                    [토론] 장기 투자하기 좋은 ETF일까?
                </a>
                <p class="text-gray-500 text-xs">2025-10-01</p>
            </li>
        </ul>
    </aside>

</main>

<div id="footer-placeholder"></div>

<!-- Chart.js Script -->
<script th:inline="javascript">
    const ctx = document.getElementById('etfChart').getContext('2d');
    const etfData = /*[[${etfDetails}]]*/ []; // Thymeleaf로부터 데이터 받기

    const labels = etfData.map(item => item.basDt);
    const prices = etfData.map(item => item.clpr);

    // 수익률 계산 함수
    const rateOfChange = (start, end) => ((end - start) / start * 100).toFixed(2);

    // 안전 인덱스 계산 (데이터가 부족하면 undefined 방지)
    const len = prices.length;
    const safeIdx = (n) => (len - n >= 0 ? len - n : 0);

    // 구간별 수익률 계산
    const overallChange  = rateOfChange(prices[0], prices[len - 1]);
    const oneYearChange  = rateOfChange(prices[safeIdx(252)], prices[len - 1]);
    const sixMonthChange = rateOfChange(prices[safeIdx(126)], prices[len - 1]);
    const threeMonthChange = rateOfChange(prices[safeIdx(63)], prices[len - 1]);
    const oneMonthChange = rateOfChange(prices[safeIdx(21)], prices[len - 1]);

    // 표시용 포맷 함수
    const formatReturn = (value) => {
      const sign = value >= 0 ? '+' : '';
      const color = value >= 0 ? 'text-red-600' : 'text-blue-600';
      return `<span class="${color}">${sign}${value}%</span>`;
    };

    // 테이블 채우기
    document.getElementById('ret-total').innerHTML = formatReturn(overallChange);
    document.getElementById('ret-1y').innerHTML    = formatReturn(oneYearChange);
    document.getElementById('ret-6m').innerHTML    = formatReturn(sixMonthChange);
    document.getElementById('ret-3m').innerHTML    = formatReturn(threeMonthChange);
    document.getElementById('ret-1m').innerHTML    = formatReturn(oneMonthChange);

    const etfChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels, // 날짜 배열
        datasets: [{
          label: 'ETF 가격',
          data: prices, // 종가 배열
          borderColor: 'rgb(37, 99, 235)',
          backgroundColor: 'rgba(37, 99, 235, 0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: 'rgb(37, 99, 235)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
</script>

</body>
</html>
